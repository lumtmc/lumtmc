name: Mirror Repository

# This triggers the workflow on any push to any branch or tag
on:
  push:
    branches: [ "**" ]
    tags: [ "**" ]
  workflow_dispatch:

# Explicitly set permissions for the GITHUB_TOKEN (Principle of Least Privilege)
permissions:
  contents: read

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Mirror to target repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MIRROR_TOKEN: ${{ secrets.MIRROR_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # Configure git to use the tokens securely via insteadOf to avoid secrets in CLI arguments
          git config --global url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"
          
          # 1. Create a bare clone of the source repository
          git clone --bare "https://github.com/${REPO}.git" mirror-repo.git
          cd mirror-repo.git
          
          # Remove the previous insteadOf rule and add the new one for the mirror push
          git config --global --remove-section url."https://x-access-token:${GITHUB_TOKEN}@github.com/"
          git config --global url."https://${MIRROR_TOKEN}@github.com/".insteadOf "https://github.com/"
          
          # 2. Force push the mirror to the target repository
          git push --mirror "https://github.com/lumtmc/.github.git"